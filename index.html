<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<title>Personal Expense Manager ‚Äî Pro Edition</title>
<style>
/* 
  ========================================
  CORE VARIABLES & THEMES (12 Total)
  ========================================
*/
:root {
  /* Base Structure */
  --font-main: system-ui, -apple-system, sans-serif;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 20px;
  --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
  --header-height: 70px;
  
  /* Theme: Light (Default) */
  --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --text-2: #64748b;
  --border: #e2e8f0; --primary: #2563eb; --primary-text: #ffffff;
  --ok: #10b981; --warn: #f59e0b; --bad: #ef4444; 
  --chip: #e0f2fe; --chip-text: #075985;
  --glow: none; --input-bg: #fff;
}

[data-theme="dark"] {
  --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --text-2: #94a3b8;
  --border: #334155; --primary: #6366f1; --primary-text: #ffffff;
  --chip: #1e1b4b; --chip-text: #a5b4fc;
}

[data-theme="hacker"] {
  --bg: #000000; --card: #050505; --text: #00ff41; --text-2: #008f11;
  --border: #003b00; --primary: #00ff41; --primary-text: #000;
  --ok: #00ff41; --warn: #facc15; --bad: #ff0033; 
  --chip: #001a00; --chip-text: #00ff41;
  --glow: 0 0 10px rgba(0, 255, 65, 0.4); --input-bg: #000;
}

[data-theme="ocean"] {
  --bg: #0c4a6e; --card: #075985; --text: #f0f9ff; --text-2: #7dd3fc;
  --border: #0369a1; --primary: #38bdf8; --primary-text: #0c4a6e;
  --chip: #0c4a6e; --chip-text: #38bdf8;
}

[data-theme="sunset"] {
  --bg: #4a0404; --card: #7f1d1d; --text: #fff7ed; --text-2: #fed7aa;
  --border: #991b1b; --primary: #fb923c; --primary-text: #fff;
  --chip: #450a0a; --chip-text: #fbbf24;
}

[data-theme="forest"] {
  --bg: #052e16; --card: #14532d; --text: #f0fdf4; --text-2: #86efac;
  --border: #166534; --primary: #4ade80; --primary-text: #052e16;
  --chip: #052e16; --chip-text: #4ade80;
}

[data-theme="berry"] {
  --bg: #4a044e; --card: #701a75; --text: #fae8ff; --text-2: #e879f9;
  --border: #a21caf; --primary: #e879f9; --primary-text: #fff;
  --chip: #4a044e; --chip-text: #e879f9;
}

[data-theme="midnight"] {
  --bg: #020617; --card: #0f172a; --text: #e2e8f0; --text-2: #94a3b8;
  --border: #1e293b; --primary: #3b82f6; --primary-text: #fff;
  --chip: #172554; --chip-text: #60a5fa;
}

[data-theme="coffee"] {
  --bg: #271a03; --card: #422006; --text: #ffedd5; --text-2: #d6d3d1;
  --border: #78350f; --primary: #d97706; --primary-text: #fff;
  --chip: #271a03; --chip-text: #fdba74;
}

[data-theme="lavender"] {
  --bg: #f3e8ff; --card: #fff; --text: #581c87; --text-2: #9333ea;
  --border: #d8b4fe; --primary: #9333ea; --primary-text: #fff;
  --chip: #faf5ff; --chip-text: #7e22ce;
}

[data-theme="slate"] {
  --bg: #334155; --card: #475569; --text: #f1f5f9; --text-2: #cbd5e1;
  --border: #64748b; --primary: #e2e8f0; --primary-text: #0f172a;
  --chip: #1e293b; --chip-text: #cbd5e1;
}

[data-theme="high-contrast"] {
  --bg: #000; --card: #000; --text: #fff; --text-2: #ddd;
  --border: #fff; --primary: #ff0; --primary-text: #000;
  --ok: #0f0; --warn: #ff0; --bad: #f00;
  --chip: #fff; --chip-text: #000;
}

/* 
  ========================================
  RESET & BASE STYLES
  ========================================
*/
*{box-sizing:border-box; outline:none; -webkit-tap-highlight-color: transparent;}
body{margin:0;font-family:var(--font-main);background:var(--bg);color:var(--text);
  line-height:1.5; transition: background 0.3s, color 0.3s; padding-bottom: 80px; }
h1,h2,h3,h4{margin:0 0 0.5rem 0; font-weight:700;}
button{font-family:inherit;}
input,select,textarea{font-family:inherit;}

/* Layout Container */
.wrap{max-width:1200px;margin:0 auto;padding:16px;}

/* 
  ========================================
  COMPONENTS
  ========================================
*/

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  border:1px solid var(--border); background:var(--card); color:var(--text);
  padding:0.55rem 1rem; border-radius:var(--radius-sm); cursor:pointer;
  font-weight:600; font-size:0.9rem; transition:all 0.2s; gap:6px;
}
.btn:hover{background:var(--border); transform: translateY(-1px);}
.btn:active{transform: translateY(0);}
.btn.primary{background:var(--primary); color:var(--primary-text); border-color:var(--primary);}
.btn.primary:hover{filter:brightness(1.1); background:var(--primary);}
.btn.ghost{background:transparent; border-color:transparent; color:var(--text-2);}
.btn.ghost:hover{color:var(--text); background:var(--border);}
.btn:disabled{opacity:0.5; cursor:not-allowed; transform:none; filter:grayscale(1);}

/* Badges & Pills */
.pill{padding:0.25rem 0.75rem; border-radius:999px; background:var(--chip); color:var(--chip-text); font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;}
.badge{display:inline-block; font-size:0.75rem; padding:0.2rem 0.6rem; border-radius:6px; background:var(--border); color:var(--text); font-weight:600;}
.ok{color:var(--ok)} .bad{color:var(--bad)}

/* Cards */
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius-md);
  padding:20px; box-shadow:var(--shadow); position:relative;}
[data-theme="hacker"] .card{box-shadow:var(--glow); border-color:var(--ok);}

/* Inputs */
input,select,textarea{width:100%; padding:0.7rem; margin-bottom:0.5rem;
  border-radius:var(--radius-sm); border:1px solid var(--border);
  background:var(--input-bg, var(--bg)); color:var(--text); font-size:1rem; transition:border 0.2s;}
input:focus,select:focus,textarea:focus{border-color:var(--primary); box-shadow:0 0 0 2px rgba(0,0,0,0.1);}
/* Placeholder fix for visibility */
::placeholder{ color: var(--text-2); opacity: 0.7; }
label{display:block; font-size:0.85rem; color:var(--text-2); margin-bottom:0.3rem; font-weight:600;}

/* Tables */
.table-wrapper{overflow-x:auto; border-radius:var(--radius-sm); border:1px solid var(--border);}
.table{width:100%; border-collapse:collapse; min-width:600px;}
.table th,.table td{padding:0.8rem; text-align:left; border-bottom:1px solid var(--border);}
.table th{background:var(--bg); font-weight:600; color:var(--text-2); font-size:0.85rem; white-space:nowrap;}
.table tr:last-child td{border-bottom:none;}
.table td.num{text-align:right; font-variant-numeric: tabular-nums;}

/* 
  ========================================
  LAYOUT SPECIFICS
  ========================================
*/

/* Header */
header{
  display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
  gap:12px; padding-bottom:20px; border-bottom:1px solid var(--border); margin-bottom:20px;
}
.header-left{display:flex; flex-direction:column; gap:4px;}
.header-right{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
.app-title{font-size:1.5rem; display:flex; align-items:center; gap:8px; color:var(--text); text-shadow: var(--glow);}
.app-subtitle{font-size:0.85rem; color:var(--text-2);}

/* Theme Selector (Right Corner Adjustment) */
.theme-select{
  padding:0.4rem 2rem 0.4rem 0.8rem;
  border-radius:20px; border:1px solid var(--border);
  background:var(--card); color:var(--text); font-size:0.85rem;
  cursor:pointer; appearance:none; background-image:url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat:no-repeat; background-position:right .5rem center; background-size:.65em auto;
  max-width:160px;
}
[data-theme="hacker"] .theme-select{ border-color:var(--ok); color:var(--ok); }

/* Auth Group */
.auth-group{display:flex; gap:8px; align-items:center;}

/* Stats Grid */
.grid-stats{display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:24px;}
.stat-card .value{font-size:1.8rem; font-weight:800; color:var(--text); margin-top:4px;}
.stat-card .label{font-size:0.85rem; color:var(--text-2); text-transform:uppercase;}

/* Tabs Navigation */
.tabs{display:flex; gap:4px; overflow-x:auto; padding-bottom:4px; margin-bottom:20px; border-bottom:1px solid var(--border); -webkit-overflow-scrolling:touch;}
.tab{
  flex:0 0 auto; padding:0.6rem 1.2rem; border:none; background:transparent;
  color:var(--text-2); font-weight:600; cursor:pointer; border-radius:var(--radius-sm) var(--radius-sm) 0 0;
  transition:all 0.2s;
}
.tab:hover{color:var(--text); background:rgba(0,0,0,0.03);}
.tab.active{color:var(--primary); background:rgba(var(--primary), 0.08); border-bottom:2px solid var(--primary);}

/* Main Content Area */
.tab-content{display:none; animation: fadeIn 0.3s ease;}
.tab-content.active{display:block;}
@keyframes fadeIn{from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);}}

/* Section Grids */
.grid-2-col{display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;}
.grid-3-col{display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;}

/* Footer */
footer{
  margin-top:40px; padding-top:20px; border-top:1px solid var(--border);
  text-align:center; color:var(--text-2); font-size:0.85rem;
}
.footer-links{display:flex; justify-content:center; gap:16px; margin-bottom:8px; flex-wrap:wrap;}
.footer-links a{color:var(--primary); text-decoration:none; cursor:pointer;}
.footer-links a:hover{text-decoration:underline;}

/* 
  ========================================
  MODALS & TOASTS
  ========================================
*/

/* Toast Notification */
#toast-container{position:fixed; bottom:20px; right:20px; z-index:2000; display:flex; flex-direction:column; gap:10px;}
.toast{
  background:var(--card); border-left:4px solid var(--primary); color:var(--text);
  padding:12px 20px; border-radius:4px; box-shadow:0 5px 15px rgba(0,0,0,0.2);
  font-size:0.9rem; animation:slideIn 0.3s ease; max-width:300px; display:flex; align-items:center; gap:10px;
}
.toast.success{border-color:var(--ok);}
.toast.error{border-color:var(--bad);}
@keyframes slideIn{from{transform:translateX(100%); opacity:0;} to{transform:translateX(0); opacity:1;}}

/* Modal Overlay */
.modal-overlay{
  position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px); z-index:1000; display:none; align-items:center; justify-content:center; padding:20px;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--card); width:100%; max-width:500px; max-height:85vh; overflow-y:auto;
  border-radius:var(--radius-md); box-shadow:var(--shadow); padding:24px; position:relative;
  animation:popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popUp{from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;}}
.modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:10px; border-bottom:1px solid var(--border);}
.modal-body{color:var(--text); font-size:0.95rem; line-height:1.6;}
.modal-body h4{color:var(--primary); margin-top:1rem;}
.close-modal{background:none; border:none; font-size:1.5rem; color:var(--text-2); cursor:pointer; padding:0; line-height:1;}

/* Shopping List Items */
.shop-item{display:flex; align-items:center; justify-content:space-between; padding:10px; background:var(--bg); border-radius:var(--radius-sm); margin-bottom:8px;}
.shop-left{display:flex; align-items:center; gap:10px;}
.shop-item.done span{text-decoration:line-through; opacity:0.6;}

/* Responsive Tweaks */
@media(max-width:768px){
  .header-right{width:100%; justify-content:space-between; margin-top:10px;}
  .theme-select{max-width:120px;}
  .tabs{padding-bottom:0;}
  .btn span{display:none;} /* Hide button text on small screens where needed, keep icons if added */
  .btn span.force-show{display:inline;}
}
</style>
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body data-theme="hacker">

  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Modals -->
  <div id="modal-guide" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><h3>User Guide</h3><button class="close-modal" onclick="closeModal('guide')">&times;</button></div>
      <div class="modal-body">
        <h4>1. Add Expenses</h4>
        <p>Go to the <strong>Expenses</strong> tab. Enter amount, date, category, and description. Click Save.</p>
        <h4>2. Manage Budgets</h4>
        <p>In the <strong>Budgets</strong> tab, set a limit for each category. The app will warn you if you overspend.</p>
        <h4>3. Shopping List</h4>
        <p>Use the <strong>Shopping</strong> tab for quick checklists. Items persist even if you close the browser.</p>
        <h4>4. CSV Export</h4>
        <p>In the <strong>Settings</strong> tab, you can now download your data as CSV files for Excel/Sheets.</p>
        <h4>5. Cloud Sync</h4>
        <p>Click <strong>Sign in with Google</strong>. You can then Export (save) or Import (restore) your data to Google Drive.</p>
      </div>
    </div>
  </div>

  <div id="modal-privacy" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><h3>Privacy Policy</h3><button class="close-modal" onclick="closeModal('privacy')">&times;</button></div>
      <div class="modal-body">
        <p><strong>Local Storage:</strong> All your data is stored locally in your browser's LocalStorage by default. We do not have access to it unless you explicitly sync.</p>
        <p><strong>Google Drive:</strong> If you use Cloud Sync, data is stored in a private JSON file in your Google Drive ("app-created files only"). We do not store your data on our servers.</p>
        <p><strong>Usage:</strong> This application is a client-side tool. No analytics or tracking scripts are embedded.</p>
      </div>
    </div>
  </div>

  <div id="modal-disclaimer" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><h3>Disclaimer</h3><button class="close-modal" onclick="closeModal('disclaimer')">&times;</button></div>
      <div class="modal-body">
        <p>This software is provided "as is", without warranty of any kind, express or implied, including but not limited to the warranties of merchantability, fitness for a particular purpose and noninfringement.</p>
        <p>In no event shall the authors or copyright holders be liable for any claim, damages or other liability, whether in an action of contract, tort or otherwise, arising from, out of or in connection with the software or the use or other dealings in the software.</p>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="header-left">
        <div class="app-title">
          <span>üí∞</span> Expense Manager
        </div>
        <div class="app-subtitle">Track, Budget, Sync & Visualize</div>
      </div>

      <div class="header-right">
        <!-- Theme Selector -->
        <select id="themeSelector" class="theme-select" onchange="setTheme(this.value)">
          <option value="light">‚òÄÔ∏è Light</option>
          <option value="dark">üåô Dark</option>
          <option value="hacker" selected>ü§ñ Hacker</option>
          <option value="ocean">üåä Ocean</option>
          <option value="sunset">üåÖ Sunset</option>
          <option value="forest">üå≤ Forest</option>
          <option value="berry">üçá Berry</option>
          <option value="midnight">üåë Midnight</option>
          <option value="coffee">‚òï Coffee</option>
          <option value="lavender">üíú Lavender</option>
          <option value="slate">üóø Slate</option>
          <option value="high-contrast">‚ö´ Contrast</option>
        </select>

        <!-- Currency -->
        <select id="currencySel" class="theme-select" style="max-width:100px" onchange="setCurrency(this.value)">
          <option value="INR">‚Çπ INR</option>
          <option value="USD">$ USD</option>
          <option value="EUR">‚Ç¨ EUR</option>
          <option value="GBP">¬£ GBP</option>
        </select>

        <!-- Auth / Sync -->
        <div class="auth-group">
          <button id="signinBtn" class="btn primary" onclick="signIn()">Sign in</button>
          <button id="syncBtn" class="btn ghost" onclick="syncToDrive()" disabled title="Sync to Drive">‚òÅÔ∏è</button>
          <button id="pullBtn" class="btn ghost" onclick="pullFromDrive()" disabled title="Import from Drive">‚¨áÔ∏è</button>
          <button id="signoutBtn" class="btn ghost" onclick="signOut()" disabled title="Sign Out">üö™</button>
        </div>
        
        <button class="btn ghost" onclick="openModal('guide')" title="Help">‚ùì</button>
      </div>
    </header>

    <!-- Stats Cards -->
    <section class="grid-stats">
      <div class="card stat-card">
        <div class="label">Total Expenses</div>
        <div id="statTotal" class="value">‚Äî</div>
      </div>
      <div class="card stat-card">
        <div class="label">Total Budget</div>
        <div id="statBudget" class="value">‚Äî</div>
      </div>
      <div class="card stat-card">
        <div class="label">Remaining</div>
        <div id="statRemain" class="value">‚Äî</div>
        <div id="remainNote" class="label" style="margin-top:4px; font-size:0.7rem;"></div>
      </div>
      <div class="card stat-card">
        <div class="label">Shopping Progress</div>
        <div id="statShop" class="value">0/0</div>
      </div>
    </section>

    <!-- Navigation Tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="expenses" onclick="switchTab('expenses')">Expenses</button>
      <button class="tab" data-tab="budgets"  onclick="switchTab('budgets')">Budgets</button>
      <button class="tab" data-tab="shopping" onclick="switchTab('shopping')">Shopping</button>
      <button class="tab" data-tab="summary"  onclick="switchTab('summary')">Summary</button>
      <button class="tab" data-tab="settings" onclick="switchTab('settings')">Settings</button>
    </nav>

    <!-- TAB: EXPENSES -->
    <section id="tab-expenses" class="tab-content active">
      <div class="grid-3-col">
        <!-- Form -->
        <div class="card">
          <h3>Add / Edit Expense</h3>
          <div style="margin-top:1rem">
            <label>Amount</label>
            <input id="expAmt" type="number" min="0" step="0.01" placeholder="0.00" />
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <label>Date</label>
                <input id="expDate" type="date" />
              </div>
              <div>
                <label>Category</label>
                <select id="expCat"></select>
              </div>
            </div>
            <label>Description</label>
            <input id="expDesc" placeholder="e.g. Lunch at cafe" />
          </div>
          <div style="display:flex; gap:8px; margin-top:1rem; flex-wrap:wrap;">
            <button class="btn primary" onclick="saveExpense()" style="flex:1">Save</button>
            <button class="btn" onclick="resetExpenseForm()">Clear</button>
            <button class="btn" onclick="addCustomCategory()">+ Cat</button>
          </div>
        </div>

        <!-- List -->
        <div class="card" style="grid-column: span 2; overflow:hidden; display:flex; flex-direction:column;">
          <div class="row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3 style="margin:0">History</h3>
            <input id="searchTxt" placeholder="Search expenses..." oninput="renderExpenses()" style="max-width:200px; margin-bottom:0;" />
          </div>
          <div class="table-wrapper">
            <table class="table">
              <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th class="num">Act</th></tr></thead>
              <tbody id="expTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: BUDGETS -->
    <section id="tab-budgets" class="tab-content">
      <div class="grid-3-col">
        <div class="card">
          <h3>Set Budget</h3>
          <div style="margin-top:1rem">
            <label>Category</label>
            <select id="budCat"></select>
            <label>Monthly Limit</label>
            <input id="budLimit" type="number" min="0" step="0.01" placeholder="0.00" />
          </div>
          <div style="margin-top:1rem">
            <button class="btn primary" onclick="setBudget()" style="width:100%">Save Budget</button>
          </div>
        </div>
        <div class="card" style="grid-column: span 2; overflow:hidden; display:flex; flex-direction:column;">
          <h3>Budget Overview</h3>
          <div class="table-wrapper" style="margin-top:1rem">
            <table class="table">
              <thead><tr><th>Category</th><th class="num">Budget</th><th class="num">Spent</th><th class="num">Left</th></tr></thead>
              <tbody id="budTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: SHOPPING -->
    <section id="tab-shopping" class="tab-content">
      <div class="card" style="max-width:600px; margin:0 auto;">
        <h3>Shopping List</h3>
        <div style="display:flex; gap:10px; margin:1rem 0;">
          <input id="shopTxt" placeholder="Add new item..." onkeydown="if(event.key==='Enter')addShop()" style="margin-bottom:0;" />
          <button class="btn primary" onclick="addShop()">Add</button>
        </div>
        <div id="shopList" style="display:flex; flex-direction:column; gap:8px;"></div>
      </div>
    </section>

    <!-- TAB: SUMMARY -->
    <section id="tab-summary" class="tab-content">
      <div class="grid-2-col">
        <div class="card">
          <h3 style="text-align:center; margin-bottom:1rem;">Expenses by Category</h3>
          <div id="pieContainer" style="display:flex; justify-content:center;">
             <svg id="pie" viewBox="0 0 220 160" width="100%" height="260"></svg>
          </div>
        </div>
        <div class="card">
          <h3 style="text-align:center; margin-bottom:1rem;">Budget vs Spent</h3>
          <div id="barContainer" style="display:flex; justify-content:center;">
            <svg id="bars" viewBox="0 0 320 180" width="100%" height="260"></svg>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: SETTINGS -->
    <section id="tab-settings" class="tab-content">
      <div class="grid-2-col">
        <!-- CSV Exports -->
        <div class="card">
          <h3>CSV Export</h3>
          <p class="muted" style="font-size:0.9rem; margin-bottom:1rem;">Download data as .csv files for Excel/Sheets.</p>
          <div class="row" style="display:flex; gap:10px; flex-direction:column;">
            <button class="btn" onclick="exportExpensesCSV()">üìÑ Expenses (CSV)</button>
            <button class="btn" onclick="exportBudgetsCSV()">üìä Budgets (CSV)</button>
            <button class="btn" onclick="exportShoppingCSV()">üõí Shopping List (CSV)</button>
          </div>
        </div>

        <!-- Cloud Sync -->
        <div class="card">
          <h3>Cloud Sync</h3>
          <p class="muted" style="font-size:0.9rem; margin-bottom:1rem;">Backup/Restore to Google Drive (JSON format).</p>
          <div class="row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="expDriveBtn" class="btn primary" onclick="syncToDrive()" disabled>Export to Drive</button>
            <button id="impDriveBtn" class="btn" onclick="pullFromDrive()" disabled>Import from Drive</button>
          </div>
          <div id="syncMeta" style="margin-top:1rem; font-size:0.8rem; color:var(--text-2);">Last synced: Never</div>
        </div>

        <!-- Local Data -->
        <div class="card">
          <h3>Local Data</h3>
          <p class="muted" style="font-size:0.9rem; margin-bottom:1rem;">Save your data to a file or load from a file.</p>
          <div class="row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" onclick="exportLocal()">Export JSON</button>
            <input id="impFile" type="file" accept="application/json" hidden />
            <button class="btn" onclick="document.getElementById('impFile').click()">Import JSON</button>
          </div>
        </div>
        <div class="card">
          <h3>Danger Zone</h3>
          <p class="muted" style="font-size:0.9rem; margin-bottom:1rem;">Clear all local data. This cannot be undone.</p>
          <button class="btn bad" onclick="clearAllData()">Reset App</button>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer>
      <div class="footer-links">
        <a onclick="openModal('guide')">User Guide</a>
        <a onclick="openModal('privacy')">Privacy Policy</a>
        <a onclick="openModal('disclaimer')">Disclaimer</a>
      </div>
      <div>Made with ‚ù§Ô∏è by <strong>Aliriyaj007</strong></div>
      <div style="margin-top:5px; font-size:0.75rem; opacity:0.7;">Version 1.0.0 &bull; Offline-Ready</div>
    </footer>

  </div>

<script>
/* ---------- State Management ---------- */
const GOOGLE_CLIENT_ID = "REPLACE_ME.apps.googleusercontent.com"; 
const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";
const DRIVE_API = "https://www.googleapis.com/drive/v3";
const DRIVE_UPLOAD = "https://www.googleapis.com/upload/drive/v3";
const BACKUP_FILENAME = "expense_manager_backup.json";

const CATEGORIES_BASE = ["Food","Transport","Utilities","Entertainment","Health","Shopping","Groceries","Other","Education","Rent"];
let state = {
  expenses: JSON.parse(localStorage.getItem("expenses")||"[]"),
  budgets: JSON.parse(localStorage.getItem("budgets")||"[]"),
  shopping: JSON.parse(localStorage.getItem("shopping")||"[]"),
  customCategories: JSON.parse(localStorage.getItem("customCategories")||"[]"),
  currency: localStorage.getItem("currency") || "INR",
  theme: localStorage.getItem("theme") || "hacker",
  lastSyncedAt: localStorage.getItem("lastSyncedAt") || null,
};
let editingId = null;
let accessToken = null;
let tokenClient = null;

/* ---------- Helpers ---------- */
function saveLS(){
  localStorage.setItem("expenses", JSON.stringify(state.expenses));
  localStorage.setItem("budgets", JSON.stringify(state.budgets));
  localStorage.setItem("shopping", JSON.stringify(state.shopping));
  localStorage.setItem("customCategories", JSON.stringify(state.customCategories));
  localStorage.setItem("currency", state.currency);
  localStorage.setItem("theme", state.theme);
  if(state.lastSyncedAt) localStorage.setItem("lastSyncedAt", state.lastSyncedAt);
}
function fmt(n){ try{ return new Intl.NumberFormat("en-US",{style:"currency",currency:state.currency,minimumFractionDigits:2}).format(+n||0);}catch{ return (+n||0).toFixed(2); } }
function byId(id){ return document.getElementById(id); }
function today(){ return new Date().toISOString().slice(0,10); }
function allCategories(){ return [...CATEGORIES_BASE, ...state.customCategories]; }

/* ---------- UI Logic ---------- */
function setTheme(t){
  state.theme=t; 
  document.body.setAttribute("data-theme",t); 
  byId("themeSelector").value = t;
  saveLS(); 
  drawCharts(); // Redraw charts for color updates
}
function setCurrency(c){ state.currency=c; byId("currencySel").value=c; saveLS(); renderAll(); }
function switchTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.toggle("active", c.id===`tab-${name}`));
  if(name==="summary") drawCharts();
}
function openModal(id){
  byId(`modal-${id}`).classList.add("open");
}
function closeModal(id){
  byId(`modal-${id}`).classList.remove("open");
}
// Close modal on outside click
document.querySelectorAll(".modal-overlay").forEach(ov => {
  ov.addEventListener("click", (e) => {
    if(e.target === ov) ov.classList.remove("open");
  });
});

// Toast Notification
function showToast(msg, type="info"){
  const container = byId("toast-container");
  const el = document.createElement("div");
  el.className = `toast ${type}`;
  const icon = type==="success"?"‚úÖ": type==="error"?"‚ùå":"‚ÑπÔ∏è";
  el.innerHTML = `<span>${icon}</span> <span>${msg}</span>`;
  container.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; setTimeout(()=>el.remove(),300); }, 3000);
}

/* ---------- CSV Export Functions ---------- */
function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function exportExpensesCSV() {
    const headers = ["ID", "Date", "Description", "Category", "Amount"];
    const rows = state.expenses.map(e => [
        e.id,
        e.date,
        `"${e.description.replace(/"/g, '""')}"`, // Escape quotes
        e.category,
        e.amount
    ]);
    const csvContent = [
        headers.join(","),
        ...rows.map(e => e.join(","))
    ].join("\n");
    downloadCSV(csvContent, "expenses.csv");
    showToast("Expenses CSV Downloaded", "success");
}

function exportBudgetsCSV() {
    recomputeSpent(); // Ensure spent is up to date
    const headers = ["Category", "Limit", "Spent", "Remaining"];
    const rows = state.budgets.map(b => [
        b.category,
        b.limit,
        b.spent,
        (b.limit - b.spent).toFixed(2)
    ]);
    const csvContent = [
        headers.join(","),
        ...rows.map(e => e.join(","))
    ].join("\n");
    downloadCSV(csvContent, "budgets.csv");
    showToast("Budgets CSV Downloaded", "success");
}

function exportShoppingCSV() {
    const headers = ["Item Name", "Status (Done/Pending)"];
    const rows = state.shopping.map(s => [
        `"${s.name.replace(/"/g, '""')}"`,
        s.done ? "Done" : "Pending"
    ]);
    const csvContent = [
        headers.join(","),
        ...rows.map(e => e.join(","))
    ].join("\n");
    downloadCSV(csvContent, "shopping_list.csv");
    showToast("Shopping CSV Downloaded", "success");
}

/* ---------- Google OAuth ---------- */
function initGIS(){
  if(!window.google) return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: DRIVE_SCOPE,
    callback: (resp) => {
      if(resp && resp.access_token){ accessToken = resp.access_token; updateCloudUI(true); autoSync(); showToast("Signed in to Google", "success"); }
    }
  });
}
function signIn(){ 
  if(window.google) tokenClient?.requestAccessToken({prompt:"consent"});
  else showToast("Google API not loaded", "error");
}
function signOut(){ accessToken=null; updateCloudUI(false); showToast("Signed out", "info"); }

async function driveFindBackup(){
  const q = encodeURIComponent(`name='${BACKUP_FILENAME}' and trashed=false`);
  const r = await fetch(`${DRIVE_API}/files?q=${q}&fields=files(id,name)`, {headers:{Authorization:`Bearer ${accessToken}`}});
  const j = await r.json(); return j?.files?.[0]?.id||null;
}
async function driveDownload(fileId){
  const r = await fetch(`${DRIVE_API}/files/${fileId}?alt=media`, {headers:{Authorization:`Bearer ${accessToken}`}});
  if(!r.ok) throw new Error("Download failed"); return r.json();
}
async function driveUpload(blob, fileId){
  const meta = {name:BACKUP_FILENAME, mimeType:"application/json"};
  const boundary = "----pmx" + Math.random().toString(16).slice(2);
  const body = [
    `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n`,
    JSON.stringify(meta), "\r\n",
    `--${boundary}\r\nContent-Type: application/json\r\n\r\n`,
    JSON.stringify(blob), "\r\n",
    `--${boundary}--`
  ].join("");
  const url = fileId ? `${DRIVE_UPLOAD}/files/${fileId}?uploadType=multipart` : `${DRIVE_UPLOAD}/files?uploadType=multipart`;
  const r = await fetch(url,{method:fileId?"PATCH":"POST",headers:{Authorization:`Bearer ${accessToken}`,"Content-Type":`multipart/related; boundary=${boundary}`},body});
  if(!r.ok) throw new Error("Upload failed"); return r.json();
}
function backupBlob(){ return {version:2,updatedAt:new Date().toISOString(),payload:{...state}}; }

async function syncToDrive(){
  if(!accessToken) return showToast("Please sign in first", "error");
  toggleSyncButtons(true);
  try{
    const id = await driveFindBackup();
    await driveUpload(backupBlob(), id);
    state.lastSyncedAt = new Date().toISOString(); saveLS(); updateSyncMeta();
    showToast("Synced to Drive!", "success");
  }catch(e){ showToast("Sync failed: " + e.message, "error"); }
  toggleSyncButtons(false);
}
async function pullFromDrive(){
  if(!accessToken) return showToast("Please sign in first", "error");
  toggleSyncButtons(true);
  try{
    const id = await driveFindBackup();
    if(!id) throw new Error("No backup found");
    const blob = await driveDownload(id);
    if(blob?.payload){
      state = {...state, ...blob.payload};
      saveLS(); hydrateForms(); renderAll();
      state.lastSyncedAt = new Date().toISOString(); saveLS(); updateSyncMeta();
      showToast("Import successful!", "success");
    }
  }catch(e){ showToast("Import failed: " + e.message, "error"); }
  toggleSyncButtons(false);
}
function autoSync(){ setTimeout(() => syncToDrive().catch(()=>{}), 1000); }
function updateCloudUI(connected){
  byId("signinBtn").disabled = connected;
  byId("signinBtn").textContent = connected ? "Signed In" : "Sign in";
  byId("syncBtn").disabled = !connected;
  byId("pullBtn").disabled = !connected;
  byId("signoutBtn").disabled = !connected;
  byId("expDriveBtn").disabled = !connected;
  byId("impDriveBtn").disabled = !connected;
}
function toggleSyncButtons(busy){
  const btns = ["syncBtn","pullBtn","expDriveBtn","impDriveBtn"];
  btns.forEach(id=> byId(id).disabled = busy || !accessToken);
}
function updateSyncMeta(){
  byId("syncMeta").textContent = "Last synced: " + (state.lastSyncedAt ? new Date(state.lastSyncedAt).toLocaleString() : "Never");
}

/* ---------- Expenses ---------- */
function hydrateForms(){
  byId("currencySel").value = state.currency;
  byId("expDate").value = today();
  const cats = allCategories();
  byId("expCat").innerHTML = cats.map(c=>`<option>${c}</option>`).join("");
  byId("budCat").innerHTML = cats.map(c=>`<option>${c}</option>`).join("");
}
function resetExpenseForm(){ 
  editingId=null; 
  byId("expAmt").value=""; 
  byId("expDesc").value=""; 
  byId("expDate").value=today(); 
  byId("expCat").value=allCategories()[0]||"Other"; 
}
function saveExpense(){
  const amount = parseFloat(byId("expAmt").value)||0;
  const desc = (byId("expDesc").value||"").trim();
  const date = byId("expDate").value || today();
  const category = byId("expCat").value || "Other";
  if(amount<=0 || !desc) return showToast("Invalid amount or description", "error");
  if(editingId){
    const i = state.expenses.findIndex(e=>e.id===editingId);
    if(i>-1) state.expenses[i] = {id:editingId, amount, description:desc, date, category};
  }else{
    state.expenses.push({id: Date.now().toString(), amount, description:desc, date, category});
  }
  saveLS(); resetExpenseForm(); renderAll(); showToast("Expense saved", "success");
}
function editExpense(id){
  const e = state.expenses.find(x=>x.id===id); if(!e) return;
  editingId = id;
  byId("expAmt").value = e.amount;
  byId("expDesc").value = e.description;
  byId("expDate").value = e.date;
  byId("expCat").value = e.category;
  window.scrollTo({top:0, behavior:'smooth'});
}
function delExpense(id){
  if(confirm("Delete this expense?")){ 
    state.expenses = state.expenses.filter(x=>x.id!==id); 
    saveLS(); renderAll(); 
    showToast("Deleted", "info");
  }
}
function addCustomCategory(){
  const v = prompt("New category name:");
  if(v && !allCategories().includes(v)){
    state.customCategories.push(v); saveLS(); hydrateForms(); renderAll();
    showToast(`Category "${v}" added`, "success");
  }
}
function renderExpenses(){
  const q = (byId("searchTxt").value||"").toLowerCase();
  const tbody = byId("expTableBody"); tbody.innerHTML="";
  [...state.expenses].sort((a,b)=>b.id.localeCompare(a.id)).filter(e=>{
    return !q || e.description.toLowerCase().includes(q) || e.category.toLowerCase().includes(q);
  }).forEach(e=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.description}</td>
      <td><span class="badge">${e.category}</span></td>
      <td class="num">${fmt(e.amount)}</td>
      <td class="num">
        <button class="btn ghost" onclick="editExpense('${e.id}')" style="padding:4px 8px;">‚úèÔ∏è</button>
        <button class="btn ghost bad" onclick="delExpense('${e.id}')" style="padding:4px 8px;">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Budgets ---------- */
function setBudget(){
  const category = byId("budCat").value;
  const limit = parseFloat(byId("budLimit").value)||0;
  if(!category || limit<=0) return showToast("Select category and valid limit", "error");
  const i = state.budgets.findIndex(b=>b.category===category);
  if(i>-1) state.budgets[i].limit = limit;
  else state.budgets.push({category, limit, spent:0});
  saveLS(); renderAll(); showToast("Budget updated", "success");
}
function recomputeSpent(){
  const totals = {};
  state.expenses.forEach(e=>{ totals[e.category]=(totals[e.category]||0)+(+e.amount||0); });
  state.budgets = state.budgets.map(b=>({ ...b, spent: totals[b.category]||0 }));
}
function renderBudgets(){
  recomputeSpent();
  const tbody = byId("budTableBody"); tbody.innerHTML="";
  state.budgets.filter(b=>b.limit>0).forEach(b=>{
    const remaining = b.limit - (b.spent||0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="badge">${b.category}</span></td>
      <td class="num">${fmt(b.limit)}</td>
      <td class="num">${fmt(b.spent||0)}</td>
      <td class="num ${remaining<0?'bad':'ok'}">${fmt(Math.abs(remaining))}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Shopping ---------- */
function addShop(){
  const txt = (byId("shopTxt").value||"").trim();
  if(!txt) return;
  state.shopping.push({id:Date.now().toString(),name:txt,done:false});
  byId("shopTxt").value=""; saveLS(); renderShopping();
}
function toggleShop(id){
  const i = state.shopping.findIndex(x=>x.id===id);
  if(i>-1){ state.shopping[i].done = !state.shopping[i].done; saveLS(); renderShopping(); }
}
function delShop(id){
  state.shopping = state.shopping.filter(x=>x.id!==id); saveLS(); renderShopping();
}
function renderShopping(){
  const div = byId("shopList"); div.innerHTML="";
  state.shopping.forEach(it=>{
    const el = document.createElement("div");
    el.className = `shop-item ${it.done?'done':''}`;
    el.innerHTML = `
      <div class="shop-left">
        <input type="checkbox" ${it.done?'checked':''} onchange="toggleShop('${it.id}')" style="width:18px; height:18px;">
        <span>${it.name}</span>
      </div>
      <button class="btn ghost bad" onclick="delShop('${it.id}')" style="padding:4px 8px;">‚úï</button>`;
    div.appendChild(el);
  });
}

/* ---------- Summary & Charts ---------- */
function totals(){
  const totalExp = state.expenses.reduce((s,e)=>s+(+e.amount||0),0);
  const totalBud = state.budgets.reduce((s,b)=>s+(+b.limit||0),0);
  const remain = totalBud - totalExp;
  const done = state.shopping.filter(x=>x.done).length;
  return {totalExp,totalBud,remain,done,items:state.shopping.length};
}
function updateStats(){
  const t = totals();
  byId("statTotal").textContent = fmt(t.totalExp);
  byId("statBudget").textContent = fmt(t.totalBud);
  const remEl = byId("statRemain");
  remEl.textContent = fmt(t.remain);
  remEl.style.color = t.remain < 0 ? 'var(--bad)' : 'var(--ok)';
  
  byId("remainNote").textContent = t.remain>=0 ? "Under budget" : "Over budget";
  byId("statShop").textContent = `${t.done}/${t.items}`;
}
function catBreakdown(){
  const map = new Map();
  state.expenses.forEach(e=>map.set(e.category,(map.get(e.category)||0)+(+e.amount||0)));
  return [...map.entries()].map(([name,value])=>({name,value})).sort((a,b)=>b.value-a.value);
}
function drawPie(){
  const svg = byId("pie"); svg.innerHTML="";
  const data = catBreakdown().filter(d=>d.value>0);
  if(!data.length){ svg.innerHTML = `<text x="110" y="90" text-anchor="middle" fill="var(--text-2)">No data</text>`; return; }
  const total = data.reduce((s,d)=>s+d.value,0);
  let a0 = -Math.PI/2, cx=80, cy=80, r=60, legendX=160, legendY=20;
  data.forEach((d,i)=>{
    const a1 = a0 + (d.value/total)*Math.PI*2;
    const p0=[cx+r*Math.cos(a0), cy+r*Math.sin(a0)];
    const p1=[cx+r*Math.cos(a1), cy+r*Math.sin(a1)];
    const large = (a1-a0)>Math.PI?1:0;
    const path = `M ${cx} ${cy} L ${p0[0]} ${p0[1]} A ${r} ${r} 0 ${large} 1 ${p1[0]} ${p1[1]} Z`;
    const color = getThemeColor(i);
    svg.insertAdjacentHTML("beforeend", `<path d="${path}" fill="${color}" stroke="var(--border)"></path>`);
    svg.insertAdjacentHTML("beforeend", `<rect x="${legendX}" y="${legendY+i*20}" width="12" height="12" fill="${color}" rx="2"></rect>
      <text x="${legendX+18}" y="${legendY+11+i*20}" font-size="11" fill="var(--text)">${d.name} (${((d.value/total)*100).toFixed(0)}%)</text>`);
    a0 = a1;
  });
}
function drawBars(){
  const svg = byId("bars"); svg.innerHTML="";
  recomputeSpent();
  const data = state.budgets.filter(b=>b.limit>0);
  if(!data.length){ svg.innerHTML = `<text x="160" y="90" text-anchor="middle" fill="var(--text-2)">No budgets set</text>`; return; }
  const W=320,H=180,pad=30, bw= Math.max(10, (W-2*pad)/data.length - 10), maxV=Math.max(...data.map(d=>Math.max(d.limit,d.spent)));
  // Axes
  svg.insertAdjacentHTML("beforeend", `<line x1="${pad}" y1="${H-pad}" x2="${W-pad}" y2="${H-pad}" stroke="var(--text-2)"></line>
                                       <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${H-pad}" stroke="var(--text-2)"></line>`);
  data.forEach((d,i)=>{
    const x = pad + i*(bw+10)+5;
    const hb = (d.limit/maxV)*(H-2*pad);
    const hs = (d.spent/maxV)*(H-2*pad);
    const yb = H-pad-hb, ys = H-pad-hs;
    svg.insertAdjacentHTML("beforeend", `<rect x="${x}" y="${yb}" width="${bw}" height="${hb}" fill="var(--primary)" opacity=".3"></rect>`);
    svg.insertAdjacentHTML("beforeend", `<rect x="${x+bw*0.2}" y="${ys}" width="${bw*0.6}" height="${hs}" fill="var(--ok)" opacity=".8"></rect>`);
    // Labels
    const labelY = H - pad + 12;
    svg.insertAdjacentHTML("beforeend", `<text x="${x+bw/2}" y="${labelY}" font-size="9" text-anchor="middle" fill="var(--text)" style="text-transform:uppercase;">${d.category.substring(0,3)}</text>`);
  });
}
function getThemeColor(i){
  const theme = document.body.getAttribute("data-theme");
  const palettes = {
    hacker: ["#39FF14","#00FF88","#99FF00","#00FFCC","#66FF00"],
    ocean:  ["#38bdf8","#818cf8","#2dd4bf","#0ea5e9","#22d3ee"],
    sunset: ["#fbbf24","#f87171","#fb923c","#c084fc","#f472b6"],
    light:  ["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6"],
    dark:   ["#6366f1","#10b981","#f59e0b","#ef4444","#8b5cf6"],
  };
  let colors = palettes[theme] || palettes.light;
  if(!palettes[theme]){
    colors = ["#2563eb","#059669","#d97706","#dc2626","#7c3aed"];
  }
  return colors[i % colors.length];
}
function drawCharts(){ drawPie(); drawBars(); }

/* ---------- Local Import/Export ---------- */
function exportLocal(){
  const blob = new Blob([JSON.stringify({version:2,updatedAt:new Date().toISOString(),payload:state},null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `expense-manager-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  showToast("File exported", "success");
}
byId("impFile").addEventListener("change", async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{ const text = await f.text(); const j = JSON.parse(text); if(j?.payload){ state = {...state, ...j.payload}; saveLS(); hydrateForms(); renderAll(); showToast("Import successful", "success"); } else throw 0; }
  catch{ showToast("Invalid backup file", "error"); }
  e.target.value="";
});

/* ---------- Reset ---------- */
function clearAllData(){
  if(confirm("Are you sure? This will wipe all data permanently.")){
    localStorage.clear();
    location.reload();
  }
}

/* ---------- Boot ---------- */
function renderAll(){
  hydrateForms(); renderExpenses(); renderBudgets(); renderShopping(); updateStats(); drawCharts(); updateSyncMeta();
}
window.addEventListener("load", ()=>{
  setTheme(state.theme); setCurrency(state.currency); hydrateForms(); renderAll();
  if(!state.budgets.length){ state.budgets = CATEGORIES_BASE.map(c=>({category:c,limit:0,spent:0})); saveLS(); }
  const t = setInterval(()=>{ if(window.google){ initGIS(); clearInterval(t); } }, 200);
});
</script>
</body>
</html>
